# CVE-2010-4221

## Experiment Environment

Ubuntu 14.04 LTS

## INSTALL & Configuration
```
wget https://github.com/downloads/proftpd/proftpd.github.com/proftpd-1.3.3a.tar.gz

./configure --prefix=`pwd`/build

make

sudo make install

```
## Problems in Installation & Configuration

when `sudo make install` to install executables into designated directory, Make.rules will use `/usr/bin/install` tool with `-s` as option. It will strip symbolic execution from executable. Therefore, you need to delete `-s` option in INSTALL\_SBIN and INSTALL\_BIN to keep symbolic exectution info.

## How to trigger vulnerability

```
sudo gdb ./build/sbin/proftpd 

(gdb) set follow-fork-mode child

(gdb) r
```

while in another terminal
```
python python-exploit.py
```

Now you will see SIGSEG 

## PoCs

[proftpd 1.3.3a exploit](https://github.com/ankh2054/python-exploits/blob/master/protfpd_exploit.py)

## Root Cause
```
pr_cmd_read { // parent function of buggy function (dominator)
	char buf[0x1008]; // stack buffer to be overflowed
	...
	pr_netio_telnet_gets(buf, 0x1007); // call buggy function
	...
}

pr_netio_telnet_gets(char* buf, size_t buflen) { // buggy function
	char* bp = buf; // stack buffer to be overflowed
	unsigned char cp;
	...
	pr_buffer_t* pbuf = netio_buffer_alloc(in_nstrm); // pbuf points to input
	...
	while(buflen && *pbuf->current != '\n') { // if buflen = 1 and *pbuf->current != '\n', what will happen ?
		cp = *pbuf->current++;
		switch(telent_mode) {
			case 0xff:
				switch(cp) {
					...
					default: // cp should not be 0xfb, 0xfc, 0xfd, 0xfe, 0xf4, 0xf2
						*bp++ = TELNET_IAC; // stack overflow here
						buflen--; // now buflen = 0
						break;
				}
				break;
			...
			default:
				telnet_mode = cp; // change telnet_mode value to 0xff
			break;
		}
		// finally break to here
		*bp++ = cp; // stack overflow here
		buflen--; // now buflen = -1, integer undeflow here
	}
}

```
## Vulnerability Patch

using version 1.3.3c as an example
+++ src/netio.c

@@ -1108,6 +1112,10 @@ data:
+ if (buflen == 0) {
+		break;
+	}

## References
