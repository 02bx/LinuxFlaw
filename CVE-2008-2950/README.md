# CVE-2008-2950

## Experiment Environment
Ubuntu 14.04 LTS

## INSTALL & Configuration
```
wget https://github.com/mudongliang/source-packages/raw/master/CVE-2008-2950/poppler-0.8.4.tar.gz
tar xvf poppler-0.8.4.tar.gz
cd poppler-0.8.4
mkdir build
CXXFLAGS="-lxml2" CFLAGS="-g -O0" ./configure --prefix=`pwd`/build
make 
make install
```

## Problems in Installation & Configuration
```
pdftoabw.o: undefined reference to symbol 'xmlSaveFormatFileEnc@@LIBXML2_2.4.30'
```
Solution: make sure you add `-lxml2` to `CXXFLAGS`

## How to trigger vulnerability
```
python poc.py debian4-pdftotext > poc.pdf
build/bin/pdftotext poc.pdf
```

## PoCs
[exploit-db](https://www.exploit-db.com/exploits/6032/)

## Vulnerability Details & Patch

### Root Cause
Catalog.cc:250
```
Catalog::readPageTree(int start) { // parent function of buggy function
	Page* page;
	page = new Page(); // call constructor function of page
	if (!page->isOk()) {
		++start;
		goto err3;
	}
	...
	err3:
	delete page; // call destructor function of page
}
```
Page.cc:231
```
Page::page() {
	lookupNF("Annots", &annots);
	if (!(annots.isRef() || annots.isArray() || annots.isNull())) {
		goto err2; // goto err2 directly without initializing pageWidgets
	}
	pageWidgets = new FormPageWidgets(); // pageWidgets get initialized here
	err2:
}
```
Page.cc:309
```
Page::~Page() {
	delete pageWidgets; // SIGSEGV here
}
```

### Stack Trace
0  FormPageWidgets::~FormPageWidgets (this=0x8100468, \_\_in\_chrg=<optimized out>) at Form.cc:1290
1  0xb7efe774 in Page::~Page (this=0x8059b50, \_\_in\_chrg=<optimized out>) at Page.cc:310
2  0xb7eacf64 in Catalog::readPageTree (this=this@entry=0x8058db0, 
    pagesDict=0x80597f0, attrs=attrs@entry=0x0, start=3, start@entry=0, 
    alreadyRead=alreadyRead@entry=0x8059590 "") at Catalog.cc:320
3  0xb7ead87c in Catalog::Catalog (this=0x8058db0, xrefA=0x8056c30) at Catalog.cc:99
4  0xb7f00f1d in PDFDoc::setup (this=this@entry=0x8056950, 
    ownerPassword=ownerPassword@entry=0x0, userPassword=userPassword@entry=0x0)
    at PDFDoc.cc:215
5  0xb7f010b8 in PDFDoc::PDFDoc (this=0x8056950, fileNameA=0x804d008, 
    ownerPassword=0x0, userPassword=0x0, guiDataA=0x0) at PDFDoc.cc:104
6  0x080492d5 in main (argc=2, argv=0xbffff2e4) at pdftotext.cc:152

## References
